name: Contact Form Handler

on:
  issues:
    types: [opened]

jobs:
  send-to-telegram:
    if: contains(github.event.issue.labels.*.name, 'contact-form')
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract Form Data
        id: extract
        run: |
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ø¨Ø¯Ù†Ù‡ Issue
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø§Ù…
          NAME=$(echo "$ISSUE_BODY" | grep -oP '(?<=\*\*ğŸ‘¤ Ù†Ø§Ù…:\*\* ).*' | head -1)
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§ÛŒÙ…ÛŒÙ„  
          EMAIL=$(echo "$ISSUE_BODY" | grep -oP '(?<=\*\*ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„:\*\* ).*' | head -1)
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÙ„ÙÙ†
          PHONE=$(echo "$ISSUE_BODY" | grep -oP '(?<=\*\*ğŸ“± ØªÙ„ÙÙ†:\*\* ).*' | head -1)
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾ÛŒØ§Ù… (Ù¾ÛŒÚ†ÛŒØ¯Ù‡â€ŒØªØ± Ø§Ø³Øª)
          MESSAGE=$(echo "$ISSUE_BODY" | sed -n '/\*\*ğŸ’¬ Ù¾ÛŒØ§Ù…:\*\*/,/---/p' | sed '1d;$d' | sed '/^$/d')
          
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "email=$EMAIL" >> $GITHUB_OUTPUT  
          echo "phone=$PHONE" >> $GITHUB_OUTPUT
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="ğŸ”” Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² ÙˆØ¨Ø³Ø§ÛŒØª
          
          ğŸ‘¤ Ù†Ø§Ù…: ${{ steps.extract.outputs.name }}
          ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„: ${{ steps.extract.outputs.email }}
          ğŸ“± ØªÙ„ÙÙ†: ${{ steps.extract.outputs.phone }}
          
          ğŸ’¬ Ù¾ÛŒØ§Ù…:
          ${{ steps.extract.outputs.message }}
          
          ğŸ”— Ù…Ø´Ø§Ù‡Ø¯Ù‡ Issue: ${{ github.event.issue.html_url }}
          â° Ø²Ù…Ø§Ù†: $(TZ='Asia/Tehran' date '+%Y-%m-%d %H:%M:%S')"
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${CHAT_ID}\",\"text\":\"${MESSAGE}\"}"

      - name: Close Issue
        run: |
          curl -s -X PATCH \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
            -d '{"state":"closed"}'