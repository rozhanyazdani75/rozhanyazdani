name: Contact Form Handler

on:
  issues:
    types: [opened]

jobs:
  send-to-telegram:
    if: contains(github.event.issue.labels.*.name, 'contact-form')
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract Form Data
        id: extract
        run: |
          # استخراج اطلاعات از بدنه Issue
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # استخراج نام
          NAME=$(echo "$ISSUE_BODY" | grep -oP '(?<=\*\*👤 نام:\*\* ).*' | head -1)
          
          # استخراج ایمیل  
          EMAIL=$(echo "$ISSUE_BODY" | grep -oP '(?<=\*\*📧 ایمیل:\*\* ).*' | head -1)
          
          # استخراج تلفن
          PHONE=$(echo "$ISSUE_BODY" | grep -oP '(?<=\*\*📱 تلفن:\*\* ).*' | head -1)
          
          # استخراج پیام (پیچیده‌تر است)
          MESSAGE=$(echo "$ISSUE_BODY" | sed -n '/\*\*💬 پیام:\*\*/,/---/p' | sed '1d;$d' | sed '/^$/d')
          
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "email=$EMAIL" >> $GITHUB_OUTPUT  
          echo "phone=$PHONE" >> $GITHUB_OUTPUT
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="🔔 پیام جدید از وبسایت
          
          👤 نام: ${{ steps.extract.outputs.name }}
          📧 ایمیل: ${{ steps.extract.outputs.email }}
          📱 تلفن: ${{ steps.extract.outputs.phone }}
          
          💬 پیام:
          ${{ steps.extract.outputs.message }}
          
          🔗 مشاهده Issue: ${{ github.event.issue.html_url }}
          ⏰ زمان: $(TZ='Asia/Tehran' date '+%Y-%m-%d %H:%M:%S')"
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${CHAT_ID}\",\"text\":\"${MESSAGE}\"}"

      - name: Close Issue
        run: |
          curl -s -X PATCH \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
            -d '{"state":"closed"}'